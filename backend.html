<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backend - Perfilamiento FCP</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <header>
        <div class="container header-container">
            <a href="index.html" class="logo">Perfilamiento<span>FCP</span></a>
            <button id="menu-toggle" class="menu-toggle">
                <i class="fas fa-bars"></i>
            </button>
            <nav>
                <ul>
                    <li><a href="index.html">Inicio</a></li>
                    <li><a href="descripcion.html">Descripción</a></li>
                    <li><a href="flujos.html">Flujos de Usuario</a></li>
                    <li><a href="tecnologia.html">Stack Tecnológico</a></li>
                    <li><a href="backend.html" class="active">Backend</a></li>
                    <li><a href="implementacion.html">Implementación</a></li>
                    <button id="theme-toggle" class="theme-toggle" title="Cambiar tema">
                        <i class="fas fa-moon"></i>
                    </button>
                </ul>
            </nav>
        </div>
    </header>

    <main>
        <section class="page-header">
            <div class="container">
                <h1 class="fade-in">Estructura Backend</h1>
                <p class="fade-in">Explora la arquitectura y componentes del backend "Perfilamiento FCP"</p>
            </div>
        </section>

        <section class="backend-structure">
            <div class="container">
                <div class="card fade-in">
                    <h2>Arquitectura</h2>
                    <p>El backend "Perfilamiento FCP" está basado en una Arquitectura Limpia/Hexagonal, utilizando el plugin co.com.bancolombia.cleanArchitecture (2.4.5) de Gradle. Esta arquitectura permite una clara separación de responsabilidades y facilita el mantenimiento y la evolución del sistema.</p>
                </div>

                <div class="diagram fade-in">
                    <svg width="800" height="500" viewBox="0 0 800 500" xmlns="http://www.w3.org/2000/svg">
                        <!-- Capa de Dominio -->
                        <circle cx="400" cy="250" r="150" fill="var(--card-bg)" stroke="var(--primary-color)" stroke-width="2" />
                        <text x="400" y="170" text-anchor="middle" fill="var(--primary-color)" font-weight="bold" font-size="18">Domain</text>
                        <text x="400" y="195" text-anchor="middle" fill="var(--text-color)" font-size="14">Entidades de Negocio</text>
                        <text x="400" y="220" text-anchor="middle" fill="var(--text-color)" font-size="14">Interfaces/Puertos</text>
                        <text x="400" y="245" text-anchor="middle" fill="var(--text-color)" font-size="14">Casos de Uso</text>
                        <text x="400" y="270" text-anchor="middle" fill="var(--text-color)" font-size="14">Lógica de Negocio</text>
                        
                        <!-- Capa de Aplicación -->
                        <circle cx="400" cy="250" r="200" fill="none" stroke="var(--primary-color)" stroke-width="2" stroke-dasharray="5,5" />
                        <text x="400" y="100" text-anchor="middle" fill="var(--primary-color)" font-weight="bold" font-size="18">Application</text>
                        <text x="400" y="125" text-anchor="middle" fill="var(--text-color)" font-size="14">Configuración Spring Boot</text>
                        <text x="400" y="150" text-anchor="middle" fill="var(--text-color)" font-size="14">Ensamblaje de Beans</text>
                        
                        <!-- Capa de Infraestructura -->
                        <circle cx="400" cy="250" r="250" fill="none" stroke="var(--primary-color)" stroke-width="2" />
                        <text x="400" y="50" text-anchor="middle" fill="var(--primary-color)" font-weight="bold" font-size="18">Infrastructure</text>
                        
                        <!-- Entry Points -->
                        <rect x="100" y="200" width="120" height="60" rx="10" fill="var(--primary-color)" />
                        <text x="160" y="235" text-anchor="middle" fill="var(--secondary-color)" font-weight="bold">Entry Points</text>
                        <text x="160" y="255" text-anchor="middle" fill="var(--secondary-color)" font-size="12">API REST</text>
                        
                        <!-- Driven Adapters -->
                        <rect x="580" y="200" width="120" height="60" rx="10" fill="var(--primary-color)" />
                        <text x="640" y="235" text-anchor="middle" fill="var(--secondary-color)" font-weight="bold">Driven Adapters</text>
                        <text x="640" y="255" text-anchor="middle" fill="var(--secondary-color)" font-size="12">JPA, REST Consumer</text>
                        
                        <!-- Helpers -->
                        <rect x="400" y="400" width="120" height="60" rx="10" fill="var(--primary-color)" />
                        <text x="460" y="435" text-anchor="middle" fill="var(--secondary-color)" font-weight="bold">Helpers</text>
                        <text x="460" y="455" text-anchor="middle" fill="var(--secondary-color)" font-size="12">Util, Mappers</text>
                    </svg>
                </div>

                <div class="card fade-in">
                    <h2>Capas de la Arquitectura</h2>
                    <div class="card-grid">
                        <div class="card">
                            <h3><i class="fas fa-cube"></i> Domain</h3>
                            <p><strong>model:</strong> Entidades de negocio, Interfaces/Puertos</p>
                            <p><strong>usecase:</strong> Lógica de negocio, Casos de Uso</p>
                        </div>
                        <div class="card">
                            <h3><i class="fas fa-cogs"></i> Application</h3>
                            <p><strong>app-service:</strong> Configuración Spring Boot, ensamblaje de Beans</p>
                        </div>
                        <div class="card">
                            <h3><i class="fas fa-layer-group"></i> Infrastructure</h3>
                            <p><strong>entry-points:</strong> API REST con Controllers y DTOs</p>
                            <p><strong>driven-adapters:</strong> JPA Repository, REST Consumer para APIs de Riesgos</p>
                            <p><strong>helpers:</strong> Utilidades, mapeadores MapStruct</p>
                        </div>
                    </div>
                </div>

                <div class="card fade-in">
                    <h2>Esquema de Base de Datos</h2>
                    <p>El backend "Perfilamiento FCP" utiliza PostgreSQL como base de datos relacional para almacenar la información necesaria para el proceso de perfilamiento.</p>
                    
                    <div class="tabs">
                        <button class="tab-btn active" data-tab="tab-tables">Tablas Principales</button>
                        <button class="tab-btn" data-tab="tab-logic">Lógica de Negocio</button>
                    </div>
                    
                    <div id="tab-tables" class="tab-content active">
                        <div class="card-grid">
                            <div class="card">
                                <h3>analisis_conveniencia</h3>
                                <p>Almacena los resultados de los análisis de conveniencia realizados.</p>
                            </div>
                            <div class="card">
                                <h3>tipo_documento</h3>
                                <p>Catálogo de tipos de documento de identidad.</p>
                            </div>
                            <div class="card">
                                <h3>encuesta_perfil_riesgo</h3>
                                <p>Información relacionada con las encuestas de perfil de riesgo.</p>
                            </div>
                            <div class="card">
                                <h3>detalle_portafolio</h3>
                                <p>Detalles de los portafolios de inversión.</p>
                            </div>
                            <div class="card">
                                <h3>detalle_matriz_conveniencia</h3>
                                <p>Matriz que define las reglas de conveniencia entre perfiles de cliente y productos.</p>
                            </div>
                            <div class="card">
                                <h3>producto</h3>
                                <p>Almacena información de los productos FCP disponibles.</p>
                            </div>
                            <div class="card">
                                <h3>alerta_producto</h3>
                                <p>Almacena alertas específicas relacionadas con productos.</p>
                            </div>
                            <div class="card">
                                <h3>plantilla_pdf</h3>
                                <p>Almacena plantillas para la generación de documentos PDF.</p>
                            </div>
                            <div class="card">
                                <h3>log_consulta</h3>
                                <p>Opcional - Registra logs de llamadas a APIs externas.</p>
                            </div>
                        </div>
                    </div>
                    
                    <div id="tab-logic" class="tab-content">
                        <div class="card">
                            <h3>Lógica de Negocio Principal</h3>
                            <ul>
                                <li><strong>Perfilamiento FCP:</strong> Implementada en los Casos de Uso (usecase). Compara perfil_riesgo_cliente con perfil_producto del FCP seleccionado, aplicando la lógica de la matriz de validación definida.</li>
                                <li><strong>Orquestación de APIs:</strong> Los Casos de Uso invocan los Gateways para llamar a las APIs de Riesgos.</li>
                                <li><strong>Generación de PDF:</strong> Un Caso de Uso o Servicio recupera la plantilla, el guion comercial y las observaciones para generar el PDF.</li>
                            </ul>
                        </div>
                        
                        <div class="card">
                            <h3>Lógica de Autenticación y Autorización</h3>
                            <ul>
                                <li><strong>Autenticación:</strong> Delegada a Azure AD (IdP) y gestionada en el frontend por MSAL.</li>
                                <li><strong>Autorización:</strong> El backend actúa como OAuth 2.0 Resource Server, validando los JWTs recibidos del frontend usando Spring Security.</li>
                            </ul>
                        </div>
                        
                        <div class="card">
                            <h3>Persistencia de Datos</h3>
                            <ul>
                                <li><strong>Tecnología:</strong> Spring Data JPA con Hibernate sobre PostgreSQL.</li>
                                <li><strong>Patrón Repositorio:</strong> Interfaces definidas en domain/model (Puertos), implementadas en infrastructure/driven-adapters/jpa-repository.</li>
                                <li><strong>Mapeo:</strong> Se utiliza MapStruct para mapear entre Entidades de Dominio y Entidades de Persistencia.</li>
                                <li><strong>Transacciones:</strong> Gestionadas declarativamente por Spring con @Transactional.</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="card fade-in">
                    <h2>Casos de Borde (Edge Cases)</h2>
                    <div class="card-grid">
                        <div class="card">
                            <h3><i class="fas fa-exclamation-triangle"></i> Manejo de Errores</h3>
                            <p>Manejo de errores y timeouts al consumir APIs de Riesgos.</p>
                        </div>
                        <div class="card">
                            <h3><i class="fas fa-check-circle"></i> Validación de Datos</h3>
                            <p>Validación de datos de entrada (DTOs) en la API REST.</p>
                        </div>
                        <div class="card">
                            <h3><i class="fas fa-database"></i> Datos Inconsistentes</h3>
                            <p>Escenarios de datos faltantes o inconsistentes de APIs externas.</p>
                        </div>
                        <div class="card">
                            <h3><i class="fas fa-key"></i> Autorización</h3>
                            <p>Lógica de autorización para "Por fuera de perfil".</p>
                        </div>
                        <div class="card">
                            <h3><i class="fas fa-shield-alt"></i> Seguridad</h3>
                            <p>Asegurar la seguridad de los datos almacenados y en tránsito.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2025 Perfilamiento FCP - Módulo Kit Capital</p>
        </div>
    </footer>

    <script src="js/main.js"></script>
</body>
</html>
